<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax:{inlineMath:[['\$','\$'],['\\(','\\)']],processEscapes:true},CommonHTML: {matchFontHeight:false}});</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

# ちょっとしたキーボードを作りたい｜その２：回路編

<h2><div align="right">yyyy/mm/dd</div></h2>

<!-- 記事ここから -->

ようやくこの計画に手をつけ始めました。というか半分忘れてました・・・  
ダッテイソガシカッタンダモン

そんな安っぽい言い訳はさておき、経過報告を兼ねて記事書きます

ちなみに、おそらくですがこのページを読めばキーマトリクスについても理解できると思います。というか、そのつもりで書きますので宜しくの程を・・・

## 作っているもの

マイコンにはSeeed Xiao RP2040を、キーの数は4列3行で12キーです  
中身は[計画編](https://pages.nchlab.net/blog/index/2)の通りYouTube用ショートカットキーボードのつもりですが、プログラムを書き換えれば自由にできるのでまあなんでも

マイコンとスイッチを実装したのがこちらになります

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190347779-79594af5-2691-41cf-b317-3535e2d6c225.png" alt="" width="75%" border="4"></div>

試作とは言え今後普通に使っていくつもりなので、マイコンは直接実装しました。まあ安いからいっかというお気持ちです

...言いたいことは分かります。僕も思ってます

「なぜキーボードにタクトツイッチを？」と思われた方も多いでしょう。僕も本当は使いたくはなかったんですが、ユニバーサル基板に直接実装できて12個以上在庫があるスイッチがコレしかなかったんですよ...不本意ですがないものは仕方がない

それは良いとして、スイッチの状態を読み取る方法ですが、キーマトリクスを使用します。以前作ったDigisparkベースの自作キーボードは直接読んでましたが、これくらいになるとキーマトリクスを使うのが自然ですよね。5キーくらいまでなら旨味はありませんが、12キーになると使用ピン数をおよそ半減させることができます

## キーマトリクスを理解する

キーマトリクスの話題になったので、簡単な説明をば

一般的に、ただ一つのスイッチを使用する場合、このような回路を使用することが多いと思います

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190350939-43704eff-dda9-48f6-9069-f866d6c9fc1e.png" alt="" width="60%" border="4"></div>

この回路図ではプルダウン抵抗を使用していますが、プルアップ抵抗を使用する場合もほぼ同じです

ここで、SW1にかかっている電圧を $ V_{SW}_ $ 、R1にかかっている電圧を $ V_{R1}_ $ 、全体を流れる電流を $ I $ としましょう

回路全体にかかっている電圧は電源電圧の $ V_{CC}_ $ なので、以下の式が成り立ちます

$ V_{SW}_ + V_{R1}_ = V_{CC}_ $

まあ当然ですね

大事なのはここからで、$ V_{SW}_ $ と $ V_{R1}_ $ が実際に取る値です  
電流が流れている時（ $ I \neg 0 $ ）と流れていない時（ $ I = 0 $ ）の二通りに場合分けできるため、それぞれで考えていきましょう

### 電流が流れている時

スイッチが押されている時、$ I \neg 0 $ となります  
実際の値は $ I = \flaq{V_{SW}}{R_1_ + R_{SW}_ + R_{Circuit}_} $ です。ここで、 $ R_1_ $ は抵抗R1が持つ抵抗値、 $ R_{SW}_ $ はスイッチの接触抵抗、 $ R_{Circuit}_ $ は回路内の導通抵抗です

これらの抵抗には電流が流れているため、 $ V = R \times I $ に従い電圧降下が生じます。R1での電圧降下 $ V_{R1}_ $ は以下の式の通りです

$ V_{R1}_ = R_1_ \times I = R_1_ \times \flaq{V_{SW}}{R_1_ + R_{SW}_ + R_{Circuit}_} $

$ R_1_ $ が $ R_{SW}_ + R_{Circuit}_ $ よりも十分大きい場合は $ V_{R1}_ = V_{CC}_ $ と近似することもできるため、一般的には接触抵抗と導通抵抗を無視して考えます

よってGPIOに接続されている点の分圧はおよそ $ V_{CC}_ $ となります

### 電流が流れていない時

スイッチが押されていない時、当然ながら電流は流れないため抵抗での電圧降下は0Vとなります

$ I \times (R_1_ + R_{SW}_ + R_{Circuit}_) = 0 $

そのためスイッチに全電圧が印加されることとなり、GPIOに接続されている点の分圧は $ V_{CC}_ - V_{SW}_ = V_{CC}_ - V_{CC}_ $ で0Vとなります

簡単にまとめると、「スイッチが押されている時は抵抗に全電圧が掛かり、押されていないときはスイッチに全電圧が掛かる」ということになります

### 閑話

余談ですが、[電流が流れている時](#電流が流れている時)のところであえて接触抵抗や導通抵抗を出しました。その理由とともに僕が普段プルアップを使用する理由を話そうかと思います  
「どうでも良いわ」という方は[キーを増やしてみる](#キーを増やしてみる)まで飛んで下さいな。クリックorタップで飛ばせます

回路によっては、マイコンのGPIOとスイッチを配置するところにかなり距離が開く場合があります。この際、必然的に電源との距離も遠くなります  
すると、 $ R_{Circuit}_ $ の値が無視できない程度になることがあります。特に、この様な回路は電流が極めて小さいため配線も細いためその分抵抗も大きくなりやすいです

仮に $R_1_ = 1k\ohm $ 、 $ R_{SW}_ = 10m\ohm $  、 $ R_{Circuit}_ = 10\ohm $ 、 $ V_{CC}_ = 5V $ と仮定して計算すると以下のようになります

全体を流れる電流について
$ I = \flaq{V_{SW}}{R_1_ + R_{SW}_ + R_{Circuit}_} = \flaq{5}{1,000 + 0.010 + 10} = 0.004950... $

抵抗R1での電圧降下について
$ V_{R1}_ = R_{1}_ \times I = 1,000 \times 0.00495 = 4.95 $

導線での導通抵抗 $ V_{Circuit}_ $ での電圧降下について
$ V_{Circuit}_ = R_{Circuit}_ * I = 10 \times 0.00495 = 0.0495 $

誤差のようにも思えますが、8bitのADCでも読み取れるくらいの分圧になっています  
8bit ADCで読み取った場合、読み取り値はおおよそ253、10bit ADCの場合は1013と、量子化誤差を考えても明確に値として出てきますね

ここで本題です。プルダウンとプルアップではどのような違いが生じるでしょうか  
場合分けして考えてみましょう

プルダウンの場合、この様な回路になります（画像再掲）

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190350939-43704eff-dda9-48f6-9069-f866d6c9fc1e.png" alt="" width="60%" border="4"></div>

スイッチが押されている時にGPIOに接続する点の電圧はどうなるかを考えるため、SWと電源からの導線を抵抗に置き換えた等価回路を以下に示します

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190432342-64ce4e41-ed60-4f3d-8684-65304c9da824.png" alt="" width="60%" border="4"></div>

R2が導通抵抗、R3が接触抵抗です  
先程の式から、R1での電圧降下は4.95Vと分かりました。つまりGPIOに印加される電圧も4.95Vとなり、若干ですが電源電圧より低くなります

プルアップの場合、この様な回路になります

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190456845-7e6472f4-212c-418c-aabd-9c6a40af29f1.png" alt="" width="60%" border="4"></div>

スイッチの接触抵抗は非常に小さいため、そこでの電圧降下は0.1mVを下回ることがほとんどで、ADCの誤差といい勝負になるため無視して考えると、スイッチが押された際のGPIOに接続している点の電位はほぼGNDと等しくなります

これらを比較すると、後者の方が電圧誤差を抑えることができ、より適していると言えるでしょう  
もちろん、プルアップ/プルダウン抵抗の値を十分大きくすることで電圧誤差を無視できる程度にまで抑えることができますが、それでもプルアップの方が電位が安定しているのには変わらないため僕は普段プルアップを採用しています

閑話休題

## キーを増やしてみる

ここで、多機能化させるためにスイッチの数を増やしてみましょう。以下の回路図通り、3つに増やした場合を考えます

<div align="center"><img src="https://user-images.githubusercontent.com/91242561/190456845-7e6472f4-212c-418c-aabd-9c6a40af29f1.png" alt="" width="60%" border="4"></div>

<!-- 記事ここまで -->

<footer><div align="right">©Nch_MOSFET</div></footer>

<!-- 画像を入れる時は
<div align="center"><img src="パス" alt="" width="75%" border="4"></div>
<div align="center"><img src="./../img/" alt="" width="75%" border="4"></div>
-->

<!-- Twitterのツイートを埋め込むときは公式の埋め込みリンクをそのまま貼るだけで良い -->
